CREATE TABLE Users (
    UID INT AUTO_INCREMENT PRIMARY KEY, -- Jedinstveni identifikator korisnika
    Username VARCHAR(50) NOT NULL UNIQUE, -- Korisničko ime, jedinstveno za svakog korisnika
    Password VARCHAR(255) NOT NULL, -- Šifra za korisnika
    DeviceID VARCHAR(255) NULL, -- Opcionalno: Serijski broj uređaja
    AllowedDevices INT DEFAULT 1, -- Broj uređaja koje korisnik sme da koristi
    CreatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- Datum kreiranja naloga
);

header('Content-Type: application/json');

// Database connection parameters
$host = 'localhost';
$db = 'your_database';
$user = 'your_username';
$pass = 'your_password';

// Connect to the database
try {
    $pdo = new PDO("mysql:host=$host;dbname=$db", $user, $pass);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    echo json_encode(['success' => false, 'message' => 'Database connection failed: ' . $e->getMessage()]);
    exit;
}

// Retrieve data from the POST request
$data = json_decode(file_get_contents('php://input'), true);
$username = $data['username'] ?? '';
$password = $data['password'] ?? '';
$deviceID = $data['deviceID'] ?? '';

// Validate input
if (empty($username) || empty($password) || empty($deviceID)) {
    echo json_encode(['success' => false, 'message' => 'Invalid input. All fields are required.']);
    exit;
}

// Check if the user exists
try {
    $stmt = $pdo->prepare("SELECT * FROM Users WHERE Username = :username AND Password = :password");
    $stmt->execute(['username' => $username, 'password' => $password]);
    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($user) {
        // Check the DeviceID
        if (is_null($user['DeviceID'])) {
            // First login, update DeviceID
            $updateStmt = $pdo->prepare("UPDATE Users SET DeviceID = :deviceID WHERE UID = :uid");
            $updateStmt->execute(['deviceID' => $deviceID, 'uid' => $user['UID']]);
            echo json_encode(['success' => true, 'message' => 'First login. DeviceID updated.']);
        } elseif ($user['DeviceID'] === $deviceID) {
            // Existing device
            echo json_encode(['success' => true, 'message' => 'Login successful.']);
        } else {
            // Device mismatch
            echo json_encode(['success' => false, 'message' => 'Access denied. DeviceID does not match.']);
        }
    } else {
        echo json_encode(['success' => false, 'message' => 'Invalid username or password.']);
    }
} catch (PDOException $e) {
    echo json_encode(['success' => false, 'message' => 'Query failed: ' . $e->getMessage()]);
}

?>
